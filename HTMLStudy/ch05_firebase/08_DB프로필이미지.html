<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 이미지</title>

    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

    <script src="../resources/js/serviceKey-info.js"></script>
    <script>
        firebase.initializeApp(firebaseConfig)
    </script>
</head>

<body>
    <h2>프로필 이미지 변경</h2>
    <div>
        <img id="profImg" src="" alt="">
    </div>
    <div>
        <input id="inputImage" type="file" accept="image/*" onchange="f_readImg()">
    </div>

    <script src="./common.js"></script>
    <script>
        const db = firebase.firestore()
        const storage = firebase.storage();

        let v_login = JSON.parse(sessionStorage.getItem("login"))

        if (!v_login) {
            location.href = "./06_DB로그인.html"
        }

        if (v_login["profImg"]) {
            document.querySelector("#profImg").src = v_login["profImg"]
        }

        function f_readImg() {
            let v_inputFile = event.target.files[0]

            let v_imgPath = "profile/" + makeUniqueId() + (v_inputFile["type"].replace("image/", "."))

            let storageRef = storage.ref()
            let path = storageRef.child(v_imgPath)

            let upload = path.put(v_inputFile)

            upload.on("state_changed",
                // 업로드 진행중 동작하는 함수
                () => {
                    console.log("업로드중...")
                },
                // 업로드 실패시 동작하는 함수
                (err) => {
                    console.error(err)
                },
                // 업로드 성공시 동작하는 함수
                () => {
                    upload.snapshot.ref.getDownloadURL()
                        .then((url) => {
                            console.log("업로드한 경로", url)

                            let v_json = { "profImg": url }

                            db.collection("member").doc(v_login["memId"]).update(v_json)
                                .then(() => {
                                    console.log("Document successfully udpate!");
                                    v_login["profImg"] = v_json["profImg"]
                                    sessionStorage.setItem("login", JSON.stringify(v_login))
                                    document.querySelector("#profImg").src = v_login["profImg"]
                                })
                                .catch((error) => {
                                    console.error("Error writing document: ", error);
                                });
                        })
                }
            )
        }
    </script>
</body>

</html>