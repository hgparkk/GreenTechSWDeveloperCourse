<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.spring.study.board.dao.IBoardDAO">
	
	<insert id="insertBoard" parameterType="BoardDTO">
		INSERT INTO boards(
			board_no,
			board_title,
			mem_id,
			board_content,
			board_date,
			del_yn
		) VALUES (
			(SELECT COUNT(*)+1 FROM boards),
			#{boardTitle},
			#{memId},
			#{boardContent},
			SYSDATE,
			'N'
		)
	</insert>
	
	<select id="getTotalCount" parameterType="SearchVO" resultType="int">
		SELECT 
			COUNT(*)
		FROM 
			boards b LEFT OUTER JOIN members a ON a.mem_id = b.mem_id
		WHERE 1 = 1
			AND b.del_yn = 'N'
			<include refid="boardSearch"/>
	</select>
	
	<select id="getBoardList" parameterType="SearchVO" resultType="BoardDTO">
		SELECT
			*
		FROM
			(
				SELECT
					a.*,
					ROWNUM AS rnum
				FROM
					(
						SELECT
							b.board_no,
							b.board_title,
							a.mem_id,
							NVL(a.mem_name,'(알 수 없음)') AS mem_name,
							b.board_content,
							TO_CHAR(b.board_date, 'MM-DD HH24:MI') AS board_date
						FROM 
							boards b LEFT OUTER JOIN members a ON a.mem_id = b.mem_id
						WHERE 1 = 1
							AND b.del_yn = 'N'
							<include refid="boardSearch"/>
							ORDER BY board_no DESC
						)a
				)
			WHERE 1 = 1
				AND rnum BETWEEN #{start} AND #{end}
	</select>
	
	<select id="getBoard" resultType="BoardDTO" parameterType="int">
		SELECT
			b.board_no,
			b.board_title,
			a.mem_id,
			NVL(a.mem_name,'(알 수 없음)') AS mem_name,
			b.board_content,
			TO_CHAR(b.board_date, 'YYYY-MM-DD HH24:MI:SS') AS board_date
		FROM 
			boards b LEFT OUTER JOIN members a ON a.mem_id = b.mem_id
		WHERE 1=1
			AND b.board_no = #{boardNo}
			AND b.del_yn = 'N'
	</select>
	
	<update id="updateBoard" parameterType="BoardDTO">
		UPDATE
			boards
		SET
			board_title = #{boardTitle},
			board_content = #{boardContent}
		WHERE 1=1
			AND board_no = #{boardNo}
	</update>
	
	<!-- 글 삭제는 보틍 테이블의 각 데이터에 DEL_YN 과 같이 삭제 여부관련 컬럼을 추가한다. Y는 삭제됨 N은 존재함 -->
	
	<update id="deleteBoard" parameterType="int">
		UPDATE
			boards
		SET
			del_yn = 'Y'
		WHERE 1=1
			AND board_no = #{boardNo}
	</update>
	
	<update id="noMemberIdBoard" parameterType="String">
		UPDATE
			boards
		SET
			mem_id = null
		WHERE
			mem_id = #{memId}
	</update>
	
	<!-- 공통 부분 묶기 -->
	
	<sql id="boardSearch">
		<if test="searchWord != null">
			<choose>
				<when test="searchOption == 'title'">AND b.board_title LIKE '%' || #{searchWord} || '%'</when>
				<when test="searchOption == 'content'">AND b.board_content LIKE '%' || #{searchWord} || '%'</when>
				<when test="searchOption == 'name'">AND a.mem_name = #{searchWord}</when>
			</choose>
		</if>
	</sql>

</mapper>
